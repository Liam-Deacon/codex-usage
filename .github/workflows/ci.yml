name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  pre-commit:
    name: Pre-commit
    runs-on: ubuntu-latest
    if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files

  build:
    name: Build (${{ matrix.os }})
    needs: [pre-commit]
    if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: ./target

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all --all-targets -- -D warnings

      - name: Build
        run: cargo build --release --verbose

      - name: Run tests
        run: cargo test --all

  release:
    name: Release (${{ matrix.platform }})
    needs: []
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-x64
            target: x86_64-apple-darwin
            runs-on: macos-13
            binary_name: codex-usage-x86_64-apple-darwin
          - platform: macos-arm64
            target: aarch64-apple-darwin
            runs-on: macos-latest
            binary_name: codex-usage-aarch64-apple-darwin
          - platform: linux-x64
            target: x86_64-unknown-linux-gnu
            runs-on: ubuntu-latest
            binary_name: codex-usage-x86_64-unknown-linux-gnu
          - platform: linux-arm64
            target: aarch64-unknown-linux-gnu
            runs-on: ubuntu-latest
            binary_name: codex-usage-aarch64-unknown-linux-gnu
          - platform: windows-x64
            target: x86_64-pc-windows-msvc
            runs-on: windows-latest
            binary_name: codex-usage.exe

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}
          path: target/${{ matrix.target }}/release/${{ matrix.binary_name }}

  publish:
    name: Publish Release
    needs: [release]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            artifacts/macos-x64/*
            artifacts/macos-arm64/*
            artifacts/linux-x64/*
            artifacts/linux-arm64/*
            artifacts/windows-x64/*
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # packages:
  #   name: Packages (RPM/DEB)
  #   needs: release
  #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
  #   runs-on: ubuntu-latest
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         - arch: amd64
  #           target: x86_64-unknown-linux-gnu
  #           rust_arch: x86_64

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Set up Rust
  #       uses: dtolnay/rust-toolchain@master
  #       with:
  #         toolchain: stable
  #         target: ${{ matrix.target }}

  #     - name: Install packaging tools
  #       run: sudo apt-get update && sudo apt-get install -y dpkg-dev rpm

  #     - name: Build
  #       run: cargo build --release --target ${{ matrix.target }}

  #     - name: Create DEB package
  #       run: bash scripts/build-deb.sh "${{ matrix.arch }}" "${{ matrix.target }}" "${{ github.ref_name }}"
  #       working-directory: ${{ github.workspace }}

  #     - name: Create RPM package
  #       run: bash scripts/build-rpm.sh "${{ matrix.arch }}" "${{ matrix.target }}" "${{ matrix.rust_arch }}" "${{ github.ref_name }}"
  #       working-directory: ${{ github.workspace }}

  #     - name: Upload Package Assets
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         tag_name: ${{ github.ref_name }}
  #         files: release/*.deb release/*.rpm
  #         draft: true
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # source:
  #   name: Source Tarball
  #   needs: []
  #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Create source tarball
  #       run: bash scripts/build-source.sh "${{ github.ref_name }}"

  #     - name: Upload Source
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         tag_name: ${{ github.ref_name }}
  #         files: release/*.tar.gz
  #         draft: true
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # homebrew:
  #   name: Homebrew
  #   needs: release
  #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Create Homebrew formula PR
  #       uses: peter-evans/create-pull-request@v6
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         commit-message: "Update codex-usage to ${{ github.ref_name }}"
  #         title: "Update codex-usage to ${{ github.ref_name }}"
  #         body: |
  #           Automated PR to update Homebrew formula for release ${{ github.ref_name }}.
  #           
  #           Note: SHA256 hashes need to be updated before merging.
  #           Run `brew audit --strict Formula/codex-usage.rb` to verify.
  #         branch: homebrew-update
  #         base: main
  #         repository: Liam-Deacon/homebrew-tap
  #         path: Formula/codex-usage.rb
  #         add-paths: Formula/codex-usage.rb
